name: Deploy WebApp + Key Vault + (Optional) Azure OpenAI

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  LOCATION: eastus
  RG_NAME: rg-github-azure-oidc
  PLAN_NAME: asp-ai100-oidc-demo
  APP_NAME: ai100-oidc-${{ github.run_id }}
  KV_NAME: kvai100${{ github.run_id }}
  OPENAI_NAME: aoai100${{ github.run_id }}
  OPENAI_SECRET_NAME: OpenAIApiKey

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Register required resource providers
        run: |
          for ns in Microsoft.KeyVault Microsoft.Web Microsoft.Storage Microsoft.CognitiveServices; do
            echo "Registering $ns"
            az provider register --namespace $ns --wait || true
            az provider show --namespace $ns --query "registrationState" -o tsv || true
          done

      - name: Create Resource Group
        run: |
          az group create --name "$RG_NAME" --location "$LOCATION" -o table
     