name: Deploy WebApp + Key Vault + (Optional) Azure OpenAI

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  LOCATION: eastus2
  RG_NAME: rg-github-azure-oidc
  PLAN_NAME: asp-ai100-oidc-demo
  APP_NAME: ai100-oidc-${{ github.run_id }}
  KV_NAME: kvai100${{ github.run_id }}
  KV_SECRET_NAME: demo-secret
  KV_SECRET_VALUE: "hello-from-keyvault"
  OPENAI_NAME: aoai100${{ github.run_id }}
  OPENAI_SECRET_NAME: OpenAIApiKey

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

        
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create or show Resource Group
        run: |
          if az group show --name "$RG_NAME" >/dev/null 2>&1; then
            echo "Resource group exists. Showing details:"
            az group show --name "$RG_NAME" -o table
          else
            echo "Creating resource group:"
            az group create --name "$RG_NAME" --location "$LOCATION" -o table
          fi

      - name: Create Key Vault
        run: |
          az keyvault create \
            --name "$KV_NAME" \
            --resource-group "$RG_NAME" \
            --location "$LOCATION" \
            --enable-rbac-authorization false \
            -o table

      - name: Show signed-in identity (proof)
        run: |
          echo "== az account show =="
          az account show -o jsonc

      - name: Confirm role assignments at RG scope (proof)
        run: |
          RG_ID=$(az group show --name "$RG_NAME" --query id -o tsv)
          echo "RG_ID=$RG_ID"
          echo "== role assignments on RG =="
          az role assignment list --scope "$RG_ID" -o table

      - name: Show provider registration states (proof)
        run: |
          for ns in Microsoft.KeyVault Microsoft.Web Microsoft.Storage Microsoft.CognitiveServices; do
            echo "== $ns =="
            az provider show --namespace $ns --query "registrationState" -o tsv || true
          done

      - name: Test App Service provider (Microsoft.Web) is usable
        continue-on-error: true
        run: |
          az appservice plan create \
            --name "test-plan-${{ github.run_id }}" \
            --resource-group "$RG_NAME" \
            --location "$LOCATION" \
            --sku B1 \
            --is-linux \
            -o table
     